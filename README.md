# pyfu: Python Firmware Updater

A small library for firmware updates over USB with devices that support the [DFU](https://www.usb.org/sites/default/files/DFU_1.1.pdf) and [DfuSe](http://dfu-util.sourceforge.net/dfuse.html) protocols. Specifically, `pyfu` supports _listing_ DFU capable devices and _downloading binary files_ to them.

## Compared to [`dfu-util`](http://dfu-util.sourceforge.net/)

`dfu-util` is the popular host side tool for interacting with DFU/DfuSe devices. `pyfu` has only a small sliver the functionality contained in `dfu-util`: Listing and downloading binary files. The reason you would use `pyfu` over `dfu-util` is if you have a Python project that needs firmware update capabilities and don't want an external (non-Python) dependency.

## Compared to [`pydfu.py`](https://github.com/openmv/openmv/blob/9f06eb4fe15f4f181250aa5848c3e3e51bb85506/tools/pydfu.py)

`pydfu.py` is a tool in the _OpenMV_ project that solves the exact problem described above, but it is only for DfuSe devices (e.g. STM32) and also hard codes a number of parameters including device address and max transfer size. It also appears to only work with `.dfu` files, which require an extra conversion step. Since binary files can be directly generated by many embedded toolchains using them is simpler, although less portable.

The code in this package originates from `pydfu.py` and the _OpenMV_ license agreement has been copied into the repository. Along with refactoring the code and adding support for "classic" DFU devices, several modernizations were added:

- Colored logs and progress bar with `rich`
- Using `logging` instead of `print` for output messages
- Consistent style with `black` and linting with `pylint`

## Dependencies

Even though this package may appear pure Python, by relying on `pyusb` we rely on `libusb` being installed. See the [`pyusb` docs](https://github.com/pyusb/pyusb#requirements-and-platform-support) for more details on platform support.

## User Guide

Install with `pip`:

```bash
pip install pyfu
```

List connected DFU devices:

```bash
pyfu --list
```

Download a file to a DfuSe capable device, specifying a start address in hex:

```bash
pyfu --download <filename> -a <start_address>
```

Download a file to a DFU capable device:

```bash
pyfu --download <filename>
```

Use the `--device` argument to specify the `vid:pid` of the device in hex if multiple are connected. See the [examples](examples/) directory for more detailed examples.

## Developer Guide

The `Makefile` contains workflow helpers for the development environment. The only prerequisite is that `pyenv` is installed.

To setup the virtual environment:

```bash
make setup
```

To activate the virtual environment:

```bash
source .venv/bin/activate
```

To run pre-commit hooks (style, linting):

```bash
make pre_commit
```

To run unit tests:

```bash
make test
```

To build the wheel:

```bash
make wheel
```

To view code coverage metrics:

```bash
make coverage
```

To delete generated files:

```bash
make clean
```
